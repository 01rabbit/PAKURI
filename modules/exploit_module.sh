#!/bin/bash
source pakuri.conf
source $MODULES/misc_module.sh
WINDOW_NAME="${modules[2]}"

function passcrack_menu()
{
    local ans

    box_1 "Password Crack"
    echo -e "-------- Select Action ---------"
    echo -e "Do you want to start?" 
    yes-no
    read -n 1 -s ans
    if [ $ans = 1 ];then
        cd $WDIR
        if [[ ! -d $WDIR/brutespray ]]; then
            mkdir $WDIR/brutespray
        else
            rm $WDIR/brutespray/*.txt
        fi

        BRUTE="$WDIR/brutespray/brute"
        tmux send-keys -t $WINDOW_NAME.1 "nmap -T4 -p- --max-retries 1 --max-scan-delay 20 --defeat-rst-ratelimit --open -oX $BRUTE-target.xml -iL $TARGETS ; \
         brutespray --file $BRUTE-target.xml --output $WDIR/brutespray/ --threads 5 --hosts 5 ; cat $WDIR/brutespray/*.txt" C-m
        tmux select-pane -t $WINDOW_NAME.0
        echo -e "Press Enter to continue..."
        read
    fi
}

function metasploit_menu()
{
    local key
    local ans

    box_2 "Metasploit"
    echo -e "------- Metasploit Menu --------"
    select_4 "Setup" "Import to msf databas" "Check the hosts (msf db)" "Check the services (msf db)"
    read -n 1 -s key
    exploit_banner
    box_2 "Metasploit"
    echo -e "------- Metasploit Menu --------"
    case $key in
        1 )
            exploit_banner
            box_2 "Metasploit"
            echo -e "------- Metasploit Menu --------"
            box_1 "Setup"
            echo -e "-------- Select Action ---------"
            select_4 "Create and initialize the msf database" "Delete msf database" "Start Matasploit" "Stop Matasploit"
            read -n 1 -s ans
            exploit_banner
            box_2 "Metasploit"
            echo -e "------- Metasploit Menu --------"
            box_1 "Setup"
            echo -e "-------- Select Action ---------"
            if [ $ans = 1 ];then
                box_1 "Create and initialize the msf database"
                tmux send-keys -t $WINDOW_NAME.1 'msfdb init' C-m
                echo -e "Press Enter to continue..."
                read
            elif [ $ans = 2 ];then
                box_2 "Delete msf database"
                echo -e "Do you really want to delete?"
                yes-no
                read -n 1 -s ans
                if [ $ans -eq 1 ];then
                    tmux send-keys -t $WINDOW_NAME.1 'msfdb delete' C-m
                    echo -e "Press Enter to continue..."
                    read
                fi
            elif [ $ans = 3 ];then
                box_3 "Start Matasploit"
                tmux send-keys -t $WINDOW_NAME.1 'msfconsole' C-m
                sleep 20
                echo -e "Press Enter to continue..."
                read
            elif [ $ans = 4 ];then
                box_4 "Stop Matasploit"
                echo -e "Running Metasploit termination processing..."
                tmux send-keys -t $WINDOW_NAME.1 'exit -y' C-m
                sleep 2
                if [ `tmux list-panes|wc -l` = 1 ];then
                    tmux split-window -t $SESSION_NAME.0 -h
                    tmux select-pane -t $SESSION_NAME.0
                else
                    tmux send-keys -t $WINDOW_NAME.1 'clear' C-m
                fi 
            fi ;;
        2 )
            box_2 "Import to msf databas"
            for i in `find $WDIR -path "$1/*.xml"`
            do
                tmux send-keys -t $WINDOW_NAME.1 "db_import $i" C-m
            done
            echo -e "Press Enter to continue..."
            read ;;
        3 )
            box_3 "Check the hosts (msf db)"
            tmux send-keys -t $WINDOW_NAME.1 'hosts' C-m
            echo -e "Press Enter to continue..."
            read ;;
        4 )
            box_4 "Check the services (msf db)"
            tmux send-keys -t $WINDOW_NAME.1 'services' C-m
            echo -e "Press Enter to continue..."
            read ;;
        9 )
            break ;;
    esac
}

function searchsploit_menu()
{
    local ans

    box_3 "Searchsploit"
    echo -e "-------- Select Action ---------"
    read -p "Imput keyword: " keyword
    tmux send-keys -t $WINDOW_NAME.1 "searchsploit $keyword" C-m
    echo -e "Select it with the mouse cursor and press enter to copy it to the clipboard."
    echo -e ""
    echo -e "Press Enter to continue..."
    read
}

function exploit_manage()
{
    local key
    local ans
    local flg_pc
    
    while :
    do
        exploit_banner
        if ps -ef|grep brutespray|grep -v "grep" >/dev/null;then
            flg_pc=1
        else
            flg_pc=0
        fi

        select_4 "Password Crack" "Metasploit" "Searchsploit" "Assist"
        read -n 1 -t 5 -s key
        exploit_banner
        if [ $flg_pc = "1" ];then
            echo -e "Password Crack process is Running!"
            echo -e "Press Enter to continue..."
            read
        else
            case "$key" in
                1 )
                    passcrack_menu ;;
                2 )
                    metasploit_menu ;;
                3 )
                    searchsploit_menu ;;
                4 )
                    tmux send-keys -t $WINDOW_NAME.1 "clear && cat $DOCUMENTS/assist_exploit.txt" C-m 
                    tmux select-pane -t $WINDOW_NAME.0 ;;
                9 )
                    tmux select-window -t "${modules[0]}" ;;
                * )
                    echo "error" ;;
            esac
        fi
    done
}
exploit_manage